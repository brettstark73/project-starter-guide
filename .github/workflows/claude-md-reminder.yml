name: CLAUDE.md Maintenance Reminder

on:
  schedule:
    # Run monthly on 1st at 9am
    - cron: '0 9 1 * *'
  workflow_dispatch: # Manual trigger

jobs:
  check-claude-md:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for analysis

      - name: Analyze CLAUDE.md Staleness
        id: analyze
        run: |
          echo "üîç Analyzing CLAUDE.md maintenance needs..."

          # Check last update date
          LAST_UPDATED=$(grep "Last Updated" CLAUDE.md | grep -oE "[0-9]{4}-[0-9]{2}-[0-9]{2}" || echo "2000-01-01")
          DAYS_OLD=$(( ($(date +%s) - $(date -d "$LAST_UPDATED" +%s)) / 86400 ))

          echo "Last updated: $LAST_UPDATED ($DAYS_OLD days ago)"

          # Check for workflow changes since last update
          WORKFLOW_CHANGES=$(git log --since="$LAST_UPDATED" --name-only --pretty=format: -- .github/workflows/ scripts/ .claude/commands/ | sort -u | wc -l)

          # Check for template changes
          TEMPLATE_CHANGES=$(git log --since="$LAST_UPDATED" --name-only --pretty=format: -- templates/ | grep -E "auth|config|package.json" | wc -l)

          echo "Workflow changes: $WORKFLOW_CHANGES"
          echo "Template changes: $TEMPLATE_CHANGES"

          # Determine if review needed
          NEEDS_REVIEW=false
          if [ $DAYS_OLD -gt 30 ] || [ $WORKFLOW_CHANGES -gt 5 ] || [ $TEMPLATE_CHANGES -gt 3 ]; then
            NEEDS_REVIEW=true
          fi

          echo "needs_review=$NEEDS_REVIEW" >> $GITHUB_OUTPUT
          echo "days_old=$DAYS_OLD" >> $GITHUB_OUTPUT
          echo "workflow_changes=$WORKFLOW_CHANGES" >> $GITHUB_OUTPUT
          echo "template_changes=$TEMPLATE_CHANGES" >> $GITHUB_OUTPUT

      - name: Create Issue Reminder
        if: steps.analyze.outputs.needs_review == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const daysOld = '${{ steps.analyze.outputs.days_old }}';
            const workflowChanges = '${{ steps.analyze.outputs.workflow_changes }}';
            const templateChanges = '${{ steps.analyze.outputs.template_changes }}';

            const body = `## üìù CLAUDE.md Maintenance Reminder

            It's time to review and update \`CLAUDE.md\`!

            **Current Status:**
            - Last updated: ${daysOld} days ago
            - Workflow changes since: ${workflowChanges} files
            - Template changes since: ${templateChanges} files

            **Review Checklist:**
            - [ ] Workflow patterns documented?
            - [ ] Testing requirements current?
            - [ ] Command permissions accurate?
            - [ ] Recent learnings captured?
            - [ ] Update "Last Updated" timestamp

            **Quick Action:**
            \`\`\`bash
            # Run the review command
            /review-claude-md
            \`\`\`

            This issue was auto-generated by the CLAUDE.md maintenance workflow.`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üìù Review and Update CLAUDE.md',
              body: body,
              labels: ['documentation', 'maintenance']
            });
